# Project: Government Scheme Benefit Simulator — Person C (Flask app + Admin UI + Dummy data)


Below is a **complete, copy-paste ready** codebase for your part (Person C). It includes a simple matching engine (so you can test without Person A/B), admin UI to verify/edit rules, analytics endpoints, and sample/dummy data inserted into a local SQLite DB at startup.

---

# Folder structure (copy this exactly)

```
gov-schemes-person-c/
├─ README.md
├─ requirements.txt
├─ run.sh
├─ webapp/
│  ├─ app.py
│  ├─ db.py
│  ├─ models.py
│  ├─ matcher.py
│  ├─ sample_data.py
│  ├─ templates/
│  │  ├─ base.html
│  │  ├─ index.html
│  │  ├─ results.html
│  │  ├─ scheme.html
│  │  ├─ admin_login.html
│  │  ├─ admin_dashboard.html
│  │  └─ admin_verify.html
│  └─ static/
│     └─ style.css
```

---

# Requirements (requirements.txt)

```
Flask>=2.0
```

---

# How to run

1. Create folder structure and copy files as shown.
2. (Optional) create a virtualenv and activate it.
3. `pip install -r requirements.txt`
4. `python webapp/app.py` (this will create `schemes.db` and populate dummy data if not present)
5. Open http://127.0.0.1:5000/

Admin login: username: `admin`, password: `password` (for demo only)

---

# File: webapp/app.py

```python
from flask import Flask, render_template, request, redirect, url_for, session, jsonify, flash
import json
import os
from db import get_db, init_db
from sample_data import ensure_sample_data
from matcher import evaluate_rules_for_profile

app = Flask(__name__)
app.secret_key = 'dev-secret-for-demo'  # change in production
DB_PATH = os.path.join(os.path.dirname(__file__), 'schemes.db')

# Initialize DB and sample data
init_db(DB_PATH)
ensure_sample_data(DB_PATH)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/match', methods=['POST'])
def match():
    profile = {
        'age': int(request.form.get('age') or 0),
        'income': float(request.form.get('income') or 0),
        'gender': request.form.get('gender') or '',
        'state': request.form.get('state') or '',
        'occupation': request.form.get('occupation') or '',
        'caste': request.form.get('caste') or '',
        'disability': request.form.get('disability') or 'no',
        'household_size': int(request.form.get('household_size') or 1)
    }
    # call matcher which returns list of results
    results = evaluate_rules_for_profile(DB_PATH, profile)
    # store in session briefly to show results page
    session['last_results'] = results
    session['profile'] = profile
    return redirect(url_for('results'))

@app.route('/results')
def results():
    results = session.get('last_results', [])
    profile = session.get('profile', {})
    return render_template('results.html', results=results, profile=profile)

@app.route('/scheme/<int:scheme_id>')
def scheme_detail(scheme_id):
    db = get_db(DB_PATH)
    cur = db.cursor()
    cur.execute('SELECT id, title, description, source_url FROM schemes WHERE id=?', (scheme_id,))
    row = cur.fetchone()
    if not row:
        return 'Scheme not found', 404
    cur.execute('SELECT id, rule_json, snippet, parser_confidence FROM scheme_rules WHERE scheme_id=?', (scheme_id,))
    rule = cur.fetchone()
    rule_json = rule[1] if rule else None
    snippet = rule[2] if rule else ''
    confidence = rule[3] if rule else None
    profile = session.get('profile')
    evaluation = None
    if profile and rule_json:
        try:
            rule_obj = json.loads(rule_json)
            # simple local evaluation using matcher evaluate
            from matcher import evaluate_rule
            ok = evaluate_rule(rule_obj, profile)
            evaluation = { 'eligible': ok }
        except Exception as e:
            evaluation = { 'error': str(e) }
    return render_template('scheme.html', scheme={'id':row[0],'title':row[1],'description':row[2],'source_url':row[3]}, snippet=snippet, rule_json=rule_json, confidence=confidence, evaluation=evaluation)

# ---------------- Admin ----------------
@app.route('/admin/login', methods=['GET','POST'])
def admin_login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        if username == 'admin' and password == 'password':
            session['admin'] = True
            return redirect(url_for('admin_dashboard'))
        else:
            flash('Invalid credentials')
    return render_template('admin_login.html')

@app.route('/admin/logout')
def admin_logout():
    session.pop('admin', None)
    return redirect(url_for('index'))

@app.route('/admin')
def admin_dashboard():
    if not session.get('admin'):
        return redirect(url_for('admin_login'))
    db = get_db(DB_PATH)
    cur = db.cursor()
    cur.execute('SELECT s.id, s.title, sr.parser_confidence, sr.id IS NOT NULL as has_rule FROM schemes s LEFT JOIN scheme_rules sr ON s.id=sr.scheme_id')
    rows = cur.fetchall()
    schemes = []
    for r in rows:
        schemes.append({'id': r[0], 'title': r[1], 'confidence': r[2], 'has_rule': bool(r[3])})
    return render_template('admin_dashboard.html', schemes=schemes)

@app.route('/admin/verify/<int:scheme_id>', methods=['GET','POST'])
def admin_verify(scheme_id):
    if not session.get('admin'):
        return redirect(url_for('admin_login'))
    db = get_db(DB_PATH)
    cur = db.cursor()
    cur.execute('SELECT id, title FROM schemes WHERE id=?', (scheme_id,))
    s = cur.fetchone()
    if not s:
        return 'Scheme not found', 404
    if request.method == 'POST':
        rule_json = request.form.get('rule_json')
        snippet = request.form.get('snippet')
        try:
            # validate JSON
            parsed = json.loads(rule_json)
        except Exception as e:
            flash('Invalid JSON: ' + str(e))
            return redirect(url_for('admin_verify', scheme_id=scheme_id))
        # upsert
        cur.execute('SELECT id FROM scheme_rules WHERE scheme_id=?', (scheme_id,))
        existing = cur.fetchone()
        if existing:
            cur.execute('UPDATE scheme_rules SET rule_json=?, snippet=?, parser_confidence=? WHERE scheme_id=?', (rule_json, snippet, 1.0, scheme_id))
        else:
            cur.execute('INSERT INTO scheme_rules (scheme_id, rule_json, snippet, parser_confidence) VALUES (?,?,?,?)', (scheme_id, rule_json, snippet, 1.0))
        db.commit()
        flash('Saved')
        return redirect(url_for('admin_dashboard'))
    else:
        cur.execute('SELECT sr.rule_json, sr.snippet, sr.parser_confidence FROM scheme_rules sr WHERE sr.scheme_id=?', (scheme_id,))
        r = cur.fetchone()
        rule_json = r[0] if r else json.dumps({'all': []}, indent=2)
        snippet = r[1] if r else 'No snippet available (dummy data)'
        return render_template('admin_verify.html', scheme={'id':s[0],'title':s[1]}, rule_json=rule_json, snippet=snippet)

# ---------------- Analytics APIs ----------------
@app.route('/api/stats/schemes_by_state')
def stats_schemes_by_state():
    db = get_db(DB_PATH)
    cur = db.cursor()
    cur.execute('SELECT state, COUNT(*) FROM schemes GROUP BY state')
    rows = cur.fetchall()
    return jsonify([{ 'state': r[0] or 'Unknown', 'count': r[1]} for r in rows])

@app.route('/api/scheme/<int:scheme_id>')
def api_scheme(scheme_id):
    db = get_db(DB_PATH)
    cur = db.cursor()
    cur.execute('SELECT id, title, description, source_url FROM schemes WHERE id=?', (scheme_id,))
    r = cur.fetchone()
    if not r:
        return jsonify({'error':'not found'}), 404
    cur.execute('SELECT rule_json, snippet, parser_confidence FROM scheme_rules WHERE scheme_id=?', (scheme_id,))
    s = cur.fetchone()
    return jsonify({ 'id': r[0], 'title': r[1], 'description': r[2], 'source_url': r[3], 'rule': json.loads(s[0]) if s else None, 'snippet': s[1] if s else None, 'confidence': s[2] if s else None })

if __name__ == '__main__':
    app.run(debug=True)
```

---
# File: webapp/db.py

```python
import sqlite3

def get_db(db_path):
    conn = sqlite3.connect(db_path, check_same_thread=False)
    return conn


def init_db(db_path):
    if not os.path.exists(db_path):
        conn = sqlite3.connect(db_path)
        cur = conn.cursor()
        cur.execute('''
        CREATE TABLE schemes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT,
            description TEXT,
            state TEXT,
            source_url TEXT
        )
        ''')
        cur.execute('''
        CREATE TABLE scheme_rules (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            scheme_id INTEGER,
            rule_json TEXT,
            snippet TEXT,
            parser_confidence REAL,
            FOREIGN KEY(scheme_id) REFERENCES schemes(id)
        )
        ''')
        conn.commit()
        conn.close()
```

Note: this file references `os` — ensure you import it (see below consolidated version).

---
# File: webapp/sample_data.py

```python
import sqlite3
import os
import json

SAMPLE_SCHEMES = [
    {
        'title': 'Young Farmers Support Scheme',
        'description': 'Support scheme for farmers aged between 18 and 35 with annual income below 500000',
        'state': 'Karnataka',
        'source_url': 'https://gov.example/young-farmers'
    },
    {
        'title': 'Senior Citizens Health Aid',
        'description': 'Health aid for citizens above 60 years with low income',
        'state': 'Maharashtra',
        'source_url': 'https://gov.example/senior-health'
    },
    {
        'title': 'Women Entrepreneur Grant',
        'description': 'Grant for women entrepreneurs with household income below 800000',
        'state': 'Karnataka',
        'source_url': 'https://gov.example/women-entrepreneur'
    }
]

# sample rule JSONs that our admin UI can edit later
SAMPLE_RULES = {
    1: json.dumps({
        'all':[{'field':'age','op':'>=','value':18},{'field':'age','op':'<=','value':35},{'field':'occupation','op':'in','value':['farmer','agricultural worker']},{'field':'income','op':'<','value':500000}],
    }),
    2: json.dumps({
        'all':[{'field':'age','op':'>=','value':60},{'field':'income','op':'<','value':400000}],
    }),
    3: json.dumps({
        'all':[{'field':'gender','op':'==','value':'female'},{'field':'income','op':'<','value':800000}],
    })
}


def ensure_sample_data(db_path):
    if os.path.exists(db_path):
        # assume data exists
        conn = sqlite3.connect(db_path)
        cur = conn.cursor()
        cur.execute('SELECT COUNT(*) FROM schemes')
        cnt = cur.fetchone()[0]
        if cnt > 0:
            conn.close()
            return
    conn = sqlite3.connect(db_path)
    cur = conn.cursor()
    # insert schemes
    for s in SAMPLE_SCHEMES:
        cur.execute('INSERT INTO schemes (title, description, state, source_url) VALUES (?,?,?,?)', (s['title'], s['description'], s['state'], s['source_url']))
    conn.commit()
    # insert rules
    for scheme_id, rule_json in SAMPLE_RULES.items():
        cur.execute('INSERT INTO scheme_rules (scheme_id, rule_json, snippet, parser_confidence) VALUES (?,?,?,?)', (scheme_id, rule_json, 'Sample extracted snippet for scheme '+str(scheme_id), 0.9))
    conn.commit()
    conn.close()
```

---
# File: webapp/matcher.py

```python
import sqlite3
import json

# Basic evaluator for our rule JSON structure

def evaluate_rule(rule, profile):
    """Return True/False for atomic rule JSON. Supports 'all' and 'any' and atomic ops."""
    if rule is None:
        return False
    if 'all' in rule:
        return all(evaluate_rule(r, profile) for r in rule['all'])
    if 'any' in rule:
        return any(evaluate_rule(r, profile) for r in rule['any'])
    # atomic
    field = rule.get('field')
    op = rule.get('op')
    value = rule.get('value')
    user_val = profile.get(field)
    # normalize
    if user_val is None:
        return False
    # numeric comparisons
    if op in ['<','<=','>','>=']:
        try:
            uv = float(user_val)
            vv = float(value)
        except:
            return False
        if op == '<': return uv < vv
        if op == '<=': return uv <= vv
        if op == '>': return uv > vv
        if op == '>=': return uv >= vv
    if op == '==':
        return str(user_val).lower() == str(value).lower()
    if op == 'in':
        # value expected list
        return str(user_val).lower() in [str(v).lower() for v in value]
    return False


def evaluate_rules_for_profile(db_path, profile):
    conn = sqlite3.connect(db_path)
    cur = conn.cursor()
    cur.execute('SELECT s.id, s.title, s.description, sr.rule_json, sr.snippet, sr.parser_confidence FROM schemes s LEFT JOIN scheme_rules sr ON s.id=sr.scheme_id')
    rows = cur.fetchall()
    results = []
    for r in rows:
        scheme_id = r[0]
        title = r[1]
        desc = r[2]
        rule_json = r[3]
        snippet = r[4]
        conf = r[5]
        passed = False
        score = 0.0
        reasons = {}
        if rule_json:
            try:
                rule_obj = json.loads(rule_json)
                passed = evaluate_rule(rule_obj, profile)
                score = 1.0 if passed else 0.0
                reasons = {'snippet': snippet}
            except Exception as e:
                reasons = {'error': str(e)}
        else:
            reasons = {'note': 'No rule available'}
        results.append({
            'scheme_id': scheme_id,
            'title': title,
            'description': desc,
            'result': 'eligible' if passed else 'not eligible',
            'score': score,
            'reasons': reasons
        })
    conn.close()
    # sort eligible first
    results = sorted(results, key=lambda x: (-x['score'], x['title']))
    return results
```

---
# File: webapp/templates/base.html

```html
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gov Schemes - Demo</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<nav class="nav">
  <a href="/">Home</a> |
  <a href="/admin">Admin</a>
</nav>
<div class="container">
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul class="flashes">
      {% for m in messages %}
        <li>{{ m }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}
  {% block body %}{% endblock %}
</div>
</body>
</html>
```

---
# File: webapp/templates/index.html

```html
{% extends 'base.html' %}
{% block body %}
<h1>Check Scheme Eligibility (Demo)</h1>
<form action="/match" method="post">
  <label>Age: <input type="number" name="age" required></label><br>
  <label>Income (annual): <input type="number" name="income" required></label><br>
  <label>Gender: <select name="gender"><option value="">--</option><option value="male">Male</option><option value="female">Female</option></select></label><br>
  <label>State: <input type="text" name="state"></label><br>
  <label>Occupation: <input type="text" name="occupation"></label><br>
  <label>Caste/Category: <input type="text" name="caste"></label><br>
  <label>Disability: <select name="disability"><option value="no">No</option><option value="yes">Yes</option></select></label><br>
  <label>Household size: <input type="number" name="household_size" value="1"></label><br>
  <button type="submit">Check</button>
</form>
{% endblock %}
```

---
# File: webapp/templates/results.html

```html
{% extends 'base.html' %}
{% block body %}
<h1>Results</h1>
<p>Your profile: {{ profile }}</p>
<table>
  <thead><tr><th>Scheme</th><th>Result</th><th>Score</th><th>Action</th></tr></thead>
  <tbody>
  {% for r in results %}
    <tr>
      <td>{{ r.title }}</td>
      <td>{{ r.result }}</td>
      <td>{{ '%.2f'|format(r.score) }}</td>
      <td><a href="/scheme/{{ r.scheme_id }}">View</a></td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
```

---
# File: webapp/templates/scheme.html

```html
{% extends 'base.html' %}
{% block body %}
<h1>{{ scheme.title }}</h1>
<p>{{ scheme.description }}</p>
<p><strong>Source:</strong> <a href="{{ scheme.source_url }}" target="_blank">Official page</a></p>
<h3>Extracted snippet</h3>
<pre>{{ snippet }}</pre>
<h3>Parsed rule (JSON)</h3>
<pre>{{ rule_json }}</pre>
<h3>Evaluation (based on your last profile)</h3>
<pre>{{ evaluation }}</pre>
{% endblock %}
```

---
# File: webapp/templates/admin_login.html

```html
{% extends 'base.html' %}
{% block body %}
<h1>Admin Login</h1>
<form method="post">
  <label>Username: <input name="username"></label><br>
  <label>Password: <input type="password" name="password"></label><br>
  <button type="submit">Login</button>
</form>
{% endblock %}
```

---
# File: webapp/templates/admin_dashboard.html

```html
{% extends 'base.html' %}
{% block body %}
<h1>Admin Dashboard</h1>
<table>
  <thead><tr><th>ID</th><th>Title</th><th>Has Rule</th><th>Confidence</th><th>Action</th></tr></thead>
  <tbody>
  {% for s in schemes %}
    <tr>
      <td>{{ s.id }}</td>
      <td>{{ s.title }}</td>
      <td>{{ s.has_rule }}</td>
      <td>{{ s.confidence }}</td>
      <td><a href="/admin/verify/{{ s.id }}">Verify</a></td>
    </tr>
  {% endfor %}
  </tbody>
</table>
<a href="/admin/logout">Logout</a>
{% endblock %}
```

---
# File: webapp/templates/admin_verify.html

```html
{% extends 'base.html' %}
{% block body %}
<h1>Verify Scheme: {{ scheme.title }}</h1>
<form method="post">
  <label>Snippet (editable):<br>
  <textarea name="snippet" rows="5" cols="80">{{ snippet }}</textarea></label><br>
  <label>Rule JSON:<br>
  <textarea name="rule_json" rows="15" cols="80">{{ rule_json }}</textarea></label><br>
  <button type="submit">Save</button>
</form>
<a href="/admin">Back</a>
{% endblock %}
```

---
# File: webapp/static/style.css

```css
body{ font-family: Arial, sans-serif; margin: 0; padding: 0; }
.nav{ background:#333; color:#fff; padding:10px }
.nav a{ color:#fff; margin-right:10px }
.container{ padding:20px }
table{ width:100%; border-collapse: collapse }
td, th{ border:1px solid #ccc; padding:8px }
.flashes{ list-style:none; padding:0; }
.flashes li{ background:#ffeeaa; padding:8px; margin-bottom:8px }
```

---

# Notes & Next steps

- This is a minimal demo implementation so you can begin front-end/integration work without Person A/B. The matching engine is intentionally simple.
- When Person B delivers the real parser/matcher, replace `matcher.evaluate_rules_for_profile` implementation or update imports to call their module.
- When Person A provides scrapers and real DB, migrate data ingestion to the production DB and switch DB_PATH accordingly.


---

If you want, I can now:
- generate a `docker-compose.yml` and `Dockerfile`, or
- produce a Trello-style kanban for your personal tasks, or
- create GitHub Actions CI YAML for running tests.

Which of these do you want next?
